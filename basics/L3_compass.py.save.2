import time
import numpy as np
import board
import adafruit_bno055
import L1_log

i2c = board.I2C()
imu = adafruit_bno055.BNO055_I2C(i2c)
imu.mode = adafruit_bno055.MAGONLY_MODE

x_min, x_max = 21.6875, 86.0
y_min, y_max = -34.1875, 26.0625
z_min, z_max = 80.9375, 146.375
declination_angle = 7

def calibrate_magnetometer(v, vmin, vmax):
    temp = (v - vmin) / (vmax - vmin)
    return 2 * temp - 1

def get_heading_deg():
    x, y, _ = imu.magnetic
    if x is None or y is None:
        return None
    x_c = calibrate_magnetometer(x, x_min, x_max)
    y_c = calibrate_magnetometer(y, y_min, y_max)
    h = np.degrees(np.arctan2(y_c, x_c)) - declination_angle
    h = -h
    while h > 180:
        h -= 360
    while h < -180:
        h += 360
    return h

def heading_to_cardinal(h):
    while h > 180:
        h -= 360
    while h < -180:
        h += 360
    if -15 <= h <= 15:
        return "E"
    elif -60 <= h < -30:
        return "North West"
    elif -120 <= h < -60:
        return "West"
    elif -150 <= h < -120:
        return "South West"
    elif h >= 165 or h <= -165:
        return "South"
    elif 120 < h <= 150:
        return "South East"
    elif 60 < h <= 120:
        return "East"
    elif 30 < h <= 60:
        return "North East"
    else:
        if -30 < h < -15:
            return "South"
        if 15 < h < 30:
            return "South"
        if -165 < h < -150:
            return "North"
        if 150 < h < 165:
            return "North"
        return "South"

def main():
    while True:
        h = get_heading_deg()
        if h is None:
            time.sleep(0.1)
            continue
        d = heading_to_cardinal(h)
        L1_log.tmpFile(h, "compassHeading.txt")
        L1_log.stringTmpFile(d, "compassDirection.txt")
        print(f"Heading: {h:.2f} deg, Direction: {d}")
        time.sleep(0.1)

if __name__ == "__main__":
    main()

